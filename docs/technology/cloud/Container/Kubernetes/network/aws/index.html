<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AWS VPC CNI #  Goal #  K8S网络需求 #   Pod之间的通信不需要通过NAT转换 Node和Pod通信不需要通过NAT转换 Pod所看到的IP地址与其他人所看到的IP地址相同   K8S运行在AWS VPC上的目标 #   Pod联网必须支持与用户从EC2联网中获得的特性相当的高吞吐量和可用性，低延迟和最小抖动 可以使用跟EC2一样的网络安全组 网络操作必须简单安全。用户必须能够应用现有的AWS VPC网络和安全最佳实践，以通过AWS VPC构建Kubernetes集群 只需几秒钟即可设置Pod网络 管理员应能够将群集扩展到2000个节点   方案 #   为每个Node(ec2)创建多个弹性网络接口(ENIs)，并分配secondary IP 对于每个Pod，选择一个可用的secondary IP，将其分配给Pod，并实现以下功能：  在单个主机上进行Pod到Pod的通信 在不同主机上进行Pod到Pod的通信 允许在Pod和AWS服务进行通信 允许Pod和本地数据中心进行通信 允许Pod和Internet进行通信     在EC2-VPC里，每个实例可以创建多个ENI，每个ENI可以分配多个IP地址。 任何发往这些IP地址之一的数据包，EC2-VPC都会将该数据包传递到实例。
ENI是虚拟网络接口，您可以将其附加到VPC中的实例。 将ENI附加到实例后，将创建一个对应的接口。 主ENI IP地址会自动分配给该接口。 所有辅助地址均未分配，并且由主机所有者决定如何配置它们。
  架构 #  Pod To Pod #    Inside a Pod #  IP address">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="AWS VPC CNI" />
<meta property="og:description" content="AWS VPC CNI #  Goal #  K8S网络需求 #   Pod之间的通信不需要通过NAT转换 Node和Pod通信不需要通过NAT转换 Pod所看到的IP地址与其他人所看到的IP地址相同   K8S运行在AWS VPC上的目标 #   Pod联网必须支持与用户从EC2联网中获得的特性相当的高吞吐量和可用性，低延迟和最小抖动 可以使用跟EC2一样的网络安全组 网络操作必须简单安全。用户必须能够应用现有的AWS VPC网络和安全最佳实践，以通过AWS VPC构建Kubernetes集群 只需几秒钟即可设置Pod网络 管理员应能够将群集扩展到2000个节点   方案 #   为每个Node(ec2)创建多个弹性网络接口(ENIs)，并分配secondary IP 对于每个Pod，选择一个可用的secondary IP，将其分配给Pod，并实现以下功能：  在单个主机上进行Pod到Pod的通信 在不同主机上进行Pod到Pod的通信 允许在Pod和AWS服务进行通信 允许Pod和本地数据中心进行通信 允许Pod和Internet进行通信     在EC2-VPC里，每个实例可以创建多个ENI，每个ENI可以分配多个IP地址。 任何发往这些IP地址之一的数据包，EC2-VPC都会将该数据包传递到实例。
ENI是虚拟网络接口，您可以将其附加到VPC中的实例。 将ENI附加到实例后，将创建一个对应的接口。 主ENI IP地址会自动分配给该接口。 所有辅助地址均未分配，并且由主机所有者决定如何配置它们。
  架构 #  Pod To Pod #    Inside a Pod #  IP address" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cctrip.github.io/notes/docs/technology/cloud/Container/Kubernetes/network/aws/" />
<meta property="article:modified_time" content="2020-08-01T22:38:34+08:00" />
<title>AWS VPC CNI | 学而不思则罔</title>
<link rel="manifest" href="/notes/manifest.json">
<link rel="icon" href="/notes/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/notes/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css" integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI=">
<script defer src="/notes/en.search.min.2567c97e627f2c7eb115106b5a4e891e9da772981b2a5a82781b800380a2f6ea.js" integrity="sha256-JWfJfmJ/LH6xFRBrWk6JHp2ncpgbKlqCeBuAA4Ci9uo="></script>

<script defer src="/notes/sw.min.2ab779ae2b5d50aeddfdd9ec3d03b41a76a3dc7461eedf8a74bbc49ef33e61e8.js" integrity="sha256-Krd5ritdUK7d/dnsPQO0Gnaj3HRh7t&#43;KdLvEnvM&#43;Yeg="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/notes"><img src="/notes/cc.jpg" alt="Logo" /><span>学而不思则罔</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
    <a href="/notes/docs/technology/" class="">技术相关</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/" class="collapsed ">系统</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/network/" class="collapsed ">网络</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/program/" class="collapsed ">编程</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/database/" class="collapsed ">数据库</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/architecture/" class="collapsed ">架构</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/" class="collapsed ">云原生</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/infrastructure/" class="">不可变基础设施</a>
  

          
  
  
  

  
  <ul>
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/" class="collapsed ">容器技术</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/map/" class="">技能图谱</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Docker/" class="collapsed ">Docker</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/" class="collapsed ">Kubernetes</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/map/" class="">技能图谱</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/arch/" class="">Kubernetes 架构</a>
  

          
  
  
  

  
  <ul>
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/api/" class="collapsed ">Kubernetes API</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/object/" class="collapsed ">Kubernetes 对象</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/network/" class="collapsed ">Kubernetes 网络</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/network/flannel/" class="">Flannel</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/network/service/" class="">Service通信</a>
  

          
  
  
  

  
  <ul>
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/network/calico/" class="">Calico</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/network/cilium/" class="">Cilium</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/network/aws/" class="active">AWS VPC CNI</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/storage/" class="collapsed ">Kubernetes 存储</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/security/" class="collapsed ">Kubernetes 安全</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Container/Kubernetes/operation/" class="collapsed ">Kubernetes 操作</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/ServiceMesh/" class="collapsed ">服务网格</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/Microservice/" class="collapsed ">微服务</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/API/" class="collapsed ">声明式API</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/DevOps/" class="collapsed ">DevOps</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/bigdata/" class="collapsed ">大数据</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/security/" class="collapsed ">安全</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/tool/" class="collapsed ">工具</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/other/" class="collapsed ">其他</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/howto/" class="collapsed ">How To</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="/notes/docs/other/" class="">非技术相关</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/other/life/" class="collapsed ">人生</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/other/learn/" class="collapsed ">方法论</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://cctrip.github.io/" target="_blank" rel="noopener">
        关于我
      </a>
  </li>
  
  <li>
    <a href="https://cctrip.github.io/posts" target="_blank" rel="noopener">
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/cctrip/notes" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/notes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>AWS VPC CNI</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown"><h1 id="aws-vpc-cni">
  AWS VPC CNI
  <a class="anchor" href="#aws-vpc-cni">#</a>
</h1>
<h2 id="goal">
  Goal
  <a class="anchor" href="#goal">#</a>
</h2>
<h3 id="k8s网络需求">
  K8S网络需求
  <a class="anchor" href="#k8s%e7%bd%91%e7%bb%9c%e9%9c%80%e6%b1%82">#</a>
</h3>
<ul>
<li>Pod之间的通信不需要通过NAT转换</li>
<li>Node和Pod通信不需要通过NAT转换</li>
<li>Pod所看到的IP地址与其他人所看到的IP地址相同</li>
</ul>
<hr>
<h3 id="k8s运行在aws-vpc上的目标">
  K8S运行在AWS VPC上的目标
  <a class="anchor" href="#k8s%e8%bf%90%e8%a1%8c%e5%9c%a8aws-vpc%e4%b8%8a%e7%9a%84%e7%9b%ae%e6%a0%87">#</a>
</h3>
<ul>
<li>Pod联网必须支持与用户从EC2联网中获得的特性相当的高吞吐量和可用性，低延迟和最小抖动</li>
<li>可以使用跟EC2一样的网络安全组</li>
<li>网络操作必须简单安全。用户必须能够应用现有的AWS VPC网络和安全最佳实践，以通过AWS VPC构建Kubernetes集群</li>
<li>只需几秒钟即可设置Pod网络</li>
<li>管理员应能够将群集扩展到2000个节点</li>
</ul>
<hr>
<h2 id="方案">
  方案
  <a class="anchor" href="#%e6%96%b9%e6%a1%88">#</a>
</h2>
<ul>
<li>为每个Node(ec2)创建多个弹性网络接口(ENIs)，并分配secondary IP</li>
<li>对于每个Pod，选择一个可用的secondary IP，将其分配给Pod，并实现以下功能：
<ul>
<li>在单个主机上进行Pod到Pod的通信</li>
<li>在不同主机上进行Pod到Pod的通信</li>
<li>允许在Pod和AWS服务进行通信</li>
<li>允许Pod和本地数据中心进行通信</li>
<li>允许Pod和Internet进行通信</li>
</ul>
</li>
</ul>
<blockquote>
<p>在EC2-VPC里，每个实例可以创建多个ENI，每个ENI可以分配多个IP地址。 任何发往这些IP地址之一的数据包，EC2-VPC都会将该数据包传递到实例。</p>
<p>ENI是虚拟网络接口，您可以将其附加到VPC中的实例。 将ENI附加到实例后，将创建一个对应的接口。 主ENI IP地址会自动分配给该接口。 所有辅助地址均未分配，并且由主机所有者决定如何配置它们。</p>
</blockquote>
<hr>
<h2 id="架构">
  架构
  <a class="anchor" href="#%e6%9e%b6%e6%9e%84">#</a>
</h2>
<h3 id="pod-to-pod">
  Pod To Pod
  <a class="anchor" href="#pod-to-pod">#</a>
</h3>
<p>
  <img src="wire-network.png" alt="img" /></p>
<hr>
<h4 id="inside-a-pod">
  Inside a Pod
  <a class="anchor" href="#inside-a-pod">#</a>
</h4>
<p>IP address</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ip addr show</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#ae81ff">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
3: eth0@if173: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">9001</span> qdisc noqueue state UP group default
    link/ether 6a:f3:a1:ff:38:a8 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
    inet 172.31.176.184/32 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre></div><p>route</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ip route show</span>
default via 169.254.1.1 dev eth0
169.254.1.1 dev eth0 scope link
</code></pre></div><p>static arp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># arp -a</span>
172-31-177-243.node-exporter.monitoring.svc.cluster.local <span style="color:#f92672">(</span>172.31.177.243<span style="color:#f92672">)</span> at 8e:6b:e1:80:7c:de <span style="color:#f92672">[</span>ether<span style="color:#f92672">]</span> on eth0
_gateway <span style="color:#f92672">(</span>169.254.1.1<span style="color:#f92672">)</span> at 8e:6b:e1:80:7c:de <span style="color:#f92672">[</span>ether<span style="color:#f92672">]</span> PERM on eth0
</code></pre></div><h4 id="on-host-side">
  On Host side
  <a class="anchor" href="#on-host-side">#</a>
</h4>
<p>ip address</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ip addr show</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#ae81ff">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">9001</span> qdisc mq state UP group default qlen <span style="color:#ae81ff">1000</span>
    link/ether 02:b1:bf:9a:b2:cb brd ff:ff:ff:ff:ff:ff
    inet 172.31.177.243/23 brd 172.31.177.255 scope global dynamic eth0
       valid_lft 2539sec preferred_lft 2539sec
    inet6 fe80::b1:bfff:fe9a:b2cb/64 scope link
       valid_lft forever preferred_lft forever
8: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">9001</span> qdisc mq state UP group default qlen <span style="color:#ae81ff">1000</span>
    link/ether 02:cd:2d:55:75:29 brd ff:ff:ff:ff:ff:ff
    inet 172.31.177.128/23 brd 172.31.177.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::cd:2dff:fe55:7529/64 scope link
       valid_lft forever preferred_lft forever
173: enic614534eb15@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">9001</span> qdisc noqueue state UP group default
    link/ether 8e:6b:e1:80:7c:de brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">3</span>
    inet6 fe80::8c6b:e1ff:fe80:7cde/64 scope link
       valid_lft forever preferred_lft forever
</code></pre></div><p>通过路由表控制Pod的出入流量</p>
<ul>
<li>
<p>main route控制进入pod的流量</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ip route show</span>
default via 172.31.176.1 dev eth0
169.254.169.254 dev eth0
172.31.176.0/23 dev eth0 proto kernel scope link src 172.31.177.243
172.31.176.184 dev enic614534eb15 scope link   <span style="color:#75715e"># &lt;----- Pod&#39;s IP</span> 
</code></pre></div></li>
<li>
<p>每个ENI都有自己的路由表，该路由表用于路由Pod的传出流量。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ip route show table 2</span>
default via 172.31.176.1 dev eth1
172.31.176.1 dev eth1 scope link
</code></pre></div></li>
<li>
<p>需要给pod ip配置策略路由，否则流量无法走到ENI的路由表</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ip rule list</span>
0:	from all lookup local
512:	from all to 172.31.176.184 lookup main  --&gt; 到Pod的流量走默认路由表
1024:	from all fwmark 0x80/0x80 lookup main
1536:	from 172.31.176.184 lookup <span style="color:#ae81ff">2</span>            --&gt; 从Pod出来的流量走ENI自己的路由表     
32766:	from all lookup main
32767:	from all lookup default
</code></pre></div></li>
</ul>
<h4 id="cni插件执行的操作">
  CNI插件执行的操作
  <a class="anchor" href="#cni%e6%8f%92%e4%bb%b6%e6%89%a7%e8%a1%8c%e7%9a%84%e6%93%8d%e4%bd%9c">#</a>
</h4>
<ul>
<li>
<p>创建veth pair，一个放到主机的namespace，一个放到Pod&rsquo;s namespace</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">ip link add veth-1 type veth peer name veth-1c  /* on host namespace <span style="font-style:italic">*/
</span><span style="font-style:italic">ip link set veth-1c netns ns1  /*</span> move veth-1c to Pod&#39;s namespace ns1 <span style="font-style:italic">*/
</span><span style="font-style:italic">ip link set veth-1 up /*</span> bring up veth-1 <span style="font-style:italic">*/
</span><span style="font-style:italic">ip netns exec ns1 ip link set veth-1c up /*</span> bring up veth-1c */
</code></pre></div></li>
<li>
<p>获取分配给实例的secondary IP地址，并在Pod的namespace中执行以下操作：</p>
<ul>
<li>分配IP给Pod的eth0</li>
<li>添加默认网关和默认路由到Pod的路由表</li>
<li>给默认网关添加静态ARP条目</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">/* To assign IP address 172.31.176.184 to Pod&#39;s namespace ns1 <span style="font-style:italic">*/
</span><span style="font-style:italic"> ip netns exec ns1 ip addr add 172.31.176.184/32 dev veth-1c /*</span> assign a IP address to veth-1c <span style="font-style:italic">*/
</span><span style="font-style:italic"> ip netns exec ns1 ip route add 169.254.1.1 dev veth-1c /*</span> add default gateway <span style="font-style:italic">*/ 
</span><span style="font-style:italic"> ip netns exec ns1 ip route add default via 169.254.1.1 dev veth-1c /*</span> add default route <span style="font-style:italic">*/
</span><span style="font-style:italic">  
</span><span style="font-style:italic"> ip netns exec ns1 arp -i veth-1c -s 169.254.1.1 &lt;veth-1&#39;s mac&gt; /*</span> add static ARP entry for default gateway */
</code></pre></div></li>
<li>
<p>在主机上添加到Pod的路由</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">/* Pod&#39;s IP address is 172.31.176.184 <span style="font-style:italic">*/
</span><span style="font-style:italic"> ip route add 172.31.176.184/32 dev veth-1 /*</span> add host route */
</code></pre></div></li>
</ul>
<h4 id="流量过程">
  流量过程
  <a class="anchor" href="#%e6%b5%81%e9%87%8f%e8%bf%87%e7%a8%8b">#</a>
</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">#以172.31.176.184为例说明node1&#39;s pod1 to node2&#39;s pod2的流量发出过程
<span style="color:#66d9ef">1.</span> pod1的默认出口为169.254.1.1(mac地址为veth pair的另一端)
<span style="color:#66d9ef">2.</span> 匹配策略路由from 172.31.176.184 lookup 2
<span style="color:#66d9ef">3.</span> 匹配路由表2 default via 172.31.176.1 dev eth1，流量从node1的eth1出口出去
<span style="color:#66d9ef">4.</span> EC2-VPC流量转发到node2的ethX

#通过172.31.176.184为例解释node2&#39;s pod2的接收过程
<span style="color:#66d9ef">5.</span> 流量进入node2的eth1接口
<span style="color:#66d9ef">6.</span> 匹配策略路由from all to 172.31.176.184 lookup main
<span style="color:#66d9ef">7.</span> 匹配路由表main 172.31.176.184 dev enic614534eb15 scope link,流量发往enic614534eb15接口
<span style="color:#66d9ef">8.</span> 通过veth pair传输给pod2

</code></pre></div><p>
  <img src="pod-pod.png" alt="img" /></p>
<hr>
<h3 id="pod-to-external">
  Pod To External
  <a class="anchor" href="#pod-to-external">#</a>
</h3>
<p>
  <img src="pod-external.png" alt="img" /></p>
<h4 id="aws_vpc_k8s_cni_externalsnat--false">
  AWS_VPC_K8S_CNI_EXTERNALSNAT = False
  <a class="anchor" href="#aws_vpc_k8s_cni_externalsnat--false">#</a>
</h4>
<p>使用iptables SNAT规则，将pod ip转换成主ENI的主IP地址</p>
<pre><code>-A POSTROUTING ! -d &lt;VPC-CIDR&gt; -m comment --comment &quot;kubenetes: SNAT for outbound traffic from cluster&quot; -m addrtype ! --dst-typ
</code></pre><h4 id="aws_vpc_k8s_cni_externalsnat--true">
  AWS_VPC_K8S_CNI_EXTERNALSNAT = True
  <a class="anchor" href="#aws_vpc_k8s_cni_externalsnat--true">#</a>
</h4>
<p>当将SNAT功能关闭后，无法通过主ENI的主IP地址做外网映射，此时需要给对应的ENI的主IP地址配置对应的外网IP，或者给子网配置默认网关</p>
<hr>
<p><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



  <div><a class="flex align-center" href="https://github.com/cctrip/notes/commit/976e9752177bae23e0f40be970d38004177a5902" title='Last modified by codecc | August 1, 2020' target="_blank" rel="noopener">
      <img src="/notes/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>August 1, 2020</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/cctrip/notes/edit/master/content/docs/technology/cloud/Container/Kubernetes/network/aws.md" target="_blank" rel="noopener">
      <img src="/notes/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>

</html>












