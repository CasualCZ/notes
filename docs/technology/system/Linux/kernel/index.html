<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="内核编译 #  概念 #  内核指的是一个提供硬件抽象层、磁盘及文件系统控制、多任务等功能的系统软件。
一般保存在/boot目录中，格式为/boot/vmlinuz-XXX
 为什么要编译内核 #    需要新功能支持
  原核心过于臃肿
  与硬件搭配的稳定性
  其他特殊需求
   编译内核 #    下载源码包， https://www.kernel.org/
  解压内核包，一般放在/usr/src/kernels目录下
 tar -Jxf /root/linux-3.16.39.tar.xz -C /usr/src/kernels/    进入内核目录
 cd /usr/src/kernels/linux-3.16.39    查看内核目录( 目录说明)
 ls -d ./*/ ./arch/ ./crypto/ ./drivers/ ./fs/ ./init/ ./kernel/ ./mm/ ./samples/ ./security/ ./tools/ ./virt/ .">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="内核" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://cctrip.github.io/notes/docs/technology/system/Linux/kernel/" />

<title>内核 | 学而不思则罔</title>
<link rel="manifest" href="/notes/manifest.json">
<link rel="icon" href="/notes/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/notes/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css" integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI=">
<script defer src="/notes/en.search.min.2c081b466ba361313dae421721f7136d284bddd9d6cc65927932eba06ad96839.js" integrity="sha256-LAgbRmujYTE9rkIXIfcTbShL3dnWzGWSeTLroGrZaDk="></script>

<script defer src="/notes/sw.min.2ab779ae2b5d50aeddfdd9ec3d03b41a76a3dc7461eedf8a74bbc49ef33e61e8.js" integrity="sha256-Krd5ritdUK7d/dnsPQO0Gnaj3HRh7t&#43;KdLvEnvM&#43;Yeg="></script>
<link rel="alternate" type="application/rss+xml" href="https://cctrip.github.io/notes/docs/technology/system/Linux/kernel/index.xml" title="学而不思则罔" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/notes"><img src="/notes/cc.jpg" alt="Logo" /><span>学而不思则罔</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
    <a href="/notes/docs/technology/" class="">技术相关</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/" class="collapsed ">系统</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Basic/" class="collapsed ">计算机基础</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Linux/" class="collapsed ">Linux系统</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Linux/base/" class="collapsed ">基础</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Linux/guideBook/" class="collapsed ">操作指南</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Linux/kernel/" class="collapsed active">内核</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Linux/kernel/opt/" class="">内核参数优化</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Linux/programming/" class="collapsed ">系统编程</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/system/Application/" class="collapsed ">应用</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/network/" class="collapsed ">网络</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/program/" class="collapsed ">编程</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/database/" class="collapsed ">数据库</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/architecture/" class="collapsed ">架构</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/cloud/" class="collapsed ">云原生</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/bigdata/" class="collapsed ">大数据</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/security/" class="collapsed ">安全</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/tool/" class="collapsed ">工具</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/other/" class="collapsed ">其他</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/howto/" class="collapsed ">How To</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/technology/leetcode/" class="collapsed ">LeetCode</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="/notes/docs/other/" class="">非技术相关</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/notes/docs/other/life/" class="collapsed ">人生</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/notes/docs/other/learn/" class="collapsed ">方法论</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://cctrip.github.io/" target="_blank" rel="noopener">
        关于我
      </a>
  </li>
  
  <li>
    <a href="https://cctrip.github.io/posts" target="_blank" rel="noopener">
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/cctrip/notes" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/notes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>内核</strong>

  <label for="toc-control">
    
    <img src="/notes/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#内核编译">内核编译</a>
      <ul>
        <li>
          <ul>
            <li><a href="#概念">概念</a></li>
            <li><a href="#为什么要编译内核">为什么要编译内核</a></li>
            <li><a href="#编译内核">编译内核</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="内核编译">
  内核编译
  <a class="anchor" href="#%e5%86%85%e6%a0%b8%e7%bc%96%e8%af%91">#</a>
</h1>
<h3 id="概念">
  概念
  <a class="anchor" href="#%e6%a6%82%e5%bf%b5">#</a>
</h3>
<p>内核指的是一个提供硬件抽象层、磁盘及文件系统控制、多任务等功能的系统软件。</p>
<p>一般保存在/boot目录中，格式为/boot/vmlinuz-XXX</p>
<hr>
<h3 id="为什么要编译内核">
  为什么要编译内核
  <a class="anchor" href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e7%bc%96%e8%af%91%e5%86%85%e6%a0%b8">#</a>
</h3>
<ul>
<li>
<p>需要新功能支持</p>
</li>
<li>
<p>原核心过于臃肿</p>
</li>
<li>
<p>与硬件搭配的稳定性</p>
</li>
<li>
<p>其他特殊需求</p>
</li>
</ul>
<hr>
<h3 id="编译内核">
  编译内核
  <a class="anchor" href="#%e7%bc%96%e8%af%91%e5%86%85%e6%a0%b8">#</a>
</h3>
<ol>
<li>
<p>下载源码包，
  <a href="https://www.kernel.org/">https://www.kernel.org/</a></p>
</li>
<li>
<p>解压内核包，一般放在/usr/src/kernels目录下</p>
<pre><code> tar -Jxf /root/linux-3.16.39.tar.xz -C /usr/src/kernels/
</code></pre>
</li>
<li>
<p>进入内核目录</p>
<pre><code> cd /usr/src/kernels/linux-3.16.39
</code></pre>
</li>
<li>
<p>查看内核目录(
  <a href="/notes/#1">目录说明</a>)</p>
<pre><code> ls -d ./*/

 ./arch/ ./crypto/ ./drivers/ ./fs/ ./init/ ./kernel/ ./mm/ ./samples/ ./security/ ./tools/ ./virt/
 ./block/ ./Documentation/ ./firmware/ ./include/ ./ipc/ ./lib/ ./net/ ./scripts/ ./sound/ ./usr/
</code></pre>
</li>
<li>
<p>清空源代码的其他信息</p>
<p>下载下来的源码包一般情况下不确定是否已经编译过，或者还残留有生成的一起文件，为了编译时不会出现未知的错误，进行清理。</p>
<pre><code> make mrproper
</code></pre>
</li>
<li>
<p>核心功能挑选(生成.config文件)(
  <a href="/notes/#2">选择界面说明</a>)</p>
<pre><code> yum  install ncurses-devel  -y

 make menuconfig 
</code></pre>
</li>
<li>
<p>生成bzImage内核 arch/x86/boot/bzImage</p>
<pre><code> make -j 4 clean

 make -j 4 bzImage
 ll arch/x86/boot/bzImage
</code></pre>
</li>
<li>
<p>编译安装模块</p>
<pre><code> make -j 4 modules

 make modules_install
</code></pre>
</li>
<li>
<p>手动添加内核</p>
<pre><code> #拷贝内核文件到/boot目录底下

 cp arch/x86/boot/bzImage /boot/vmlinuz-`basename /lib/modules/3.16.39/`
	
 #备份.config文件
 cp .config /boot/config-`basename /lib/modules/3.16.39/`
	
 #添加可执行权限
 chmod a+x /boot/vmlinuz-3.16.39
	
 #拷贝系统内核映射文件
 cp System.map /boot/System.map-`basename /lib/modules/3.16.39/`
	
 #拷贝内核模块列表
 gzip -c Module.symvers &gt; /boot/symvers-`basename /lib/modules/3.16.39/`.gz
</code></pre>
</li>
<li>
<p>配置grub</p>
<pre><code>#生成对应版本的initramfs文件

dracut -v /boot/initramfs-`basename /lib/modules/3.16.39/` 3.16.39
	
#更新grub.cfg配置，加入新内核记录
grub2-mkconfig -o /boot/grub2/grub.cfg 
</code></pre>
</li>
<li>
<p>查看grub配置/boot/grub2/grub.conf</p>
<p>
  <img src="grub-conf.png" alt="" /></p>
</li>
<li>
<p>重启机器，选择新内核启动</p>
</li>
</ol>
<hr>
<h4 id="1">目录说明</h4>
<ul>
<li>
<p>arch：与硬件平台有关的项目，大部分指的是CPU的类型，例如x86,x86_64,Xen虚拟支持等。</p>
</li>
<li>
<p>block：与成组设备较相关的设定数据，区块数据通常指一些大量存储媒体，还包括类似ext3等文件系统的支持是否允许等。</p>
</li>
<li>
<p>crypto：核心所支持的加密技术，如md5、des、sha512等。</p>
</li>
<li>
<p>Documentation：与核心有关的一堆说明文件，其中包括了对上面所有目录里的说明。</p>
</li>
<li>
<p>firmware：一些旧式硬件的微脚步数据。</p>
</li>
<li>
<p>fs：内核所支持的filesystems（文件系统），例如ext系列、ntfs、reisefs等。</p>
</li>
<li>
<p>include：一些可让其它过程调用的标头(header)定义数据。</p>
</li>
<li>
<p>init：一些初始化的定义功能，包括挂载和init 程序的呼叫等。</p>
</li>
<li>
<p>ipc：定义Linux操作系统内各程序进程间的通信。</p>
</li>
<li>
<p>kernel：定义核心的程序、核心状态、线程、程序的排程(schedule)、程序的讯号(signle)等。</p>
</li>
<li>
<p>lib：一些函数库。</p>
</li>
<li>
<p>mm：与内存单元有关的各项数据，包括swap与虚拟内存等。</p>
</li>
<li>
<p>net：与网络有关的各项协议数据，还有防火墙模块(net/ipv4/netfilter/*) 等。</p>
</li>
<li>
<p>security：包括selinux等在内的安全性设定。</p>
</li>
<li>
<p>sound：与音效有关的各项模块。</p>
</li>
<li>
<p>virt：与虚拟化机器有关的信息，目前核心支持的是KVM( Kernel base Vitual Machine )。</p>
</li>
</ul>
<hr>
<h4 id="2">选择界面说明</h4>
<ul>
<li>
<p>make help：        支持“更新模式进行配置”。</p>
</li>
<li>
<p>make menuconfig：     基于curses的文本窗口界面</p>
</li>
<li>
<p>make gconfig：       基于GTK(GOME)环境窗口界面</p>
</li>
<li>
<p>make xconfig：       基于QT(KDE) 环境的窗口界面</p>
</li>
<li>
<p>make config：       老旧的命令行遍历方式逐一配置每个可配置的选项</p>
</li>
<li>
<p>make oldconfig：   透过已经存在的./.config文件内容，并使用该文件内设定值为默认值，只将新版本核心的新功能列出让用户选择，可以简化核心功能挑选过程。对与升级内核很好选择。</p>
</li>
<li>
<p>make defconfig：     基于内核为目标平台执行提供的“默认”配置进行配置</p>
</li>
<li>
<p>make allyesconfig：    所有选项均回答为”yes”</p>
</li>
<li>
<p>make allnoconfig：    所有选项均回答为”no”</p>
</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



  <div><a class="flex align-center" href="https://github.com/cctrip/notes/commit/dedd326a507bc06573a9198e14fade07c853efa4" title='Last modified by codecc | August 21, 2020' target="_blank" rel="noopener">
      <img src="/notes/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>August 21, 2020</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/cctrip/notes/edit/master/content/docs/technology/system/Linux/kernel/_index.md" target="_blank" rel="noopener">
      <img src="/notes/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#内核编译">内核编译</a>
      <ul>
        <li>
          <ul>
            <li><a href="#概念">概念</a></li>
            <li><a href="#为什么要编译内核">为什么要编译内核</a></li>
            <li><a href="#编译内核">编译内核</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












